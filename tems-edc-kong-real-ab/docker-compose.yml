version: "3.9"

networks:
  dataspace:

volumes:
  grafana_data:
  postgres_a_data:
  postgres_b_data:
  vault_data:

services:
  # ======================
  # VAULT (DEV MODE)
  # ======================
  vault:
    image: hashicorp/vault:1.16
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    volumes:
      - vault_data:/vault/data
    networks: [dataspace]

  # ======================
  # ZOOKEEPER
  # ======================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    networks: [dataspace]

  # ======================
  # KAFKA
  # ======================
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on: [zookeeper]
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports:
      - "9092:9092"
    networks: [dataspace]

  # ======================
  # POSTGRES (A)
  # ======================
  postgres-a:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: edc
      POSTGRES_PASSWORD: edc
      POSTGRES_DB: edc
    ports:
      - "5432:5432"
    volumes:
      - postgres_a_data:/var/lib/postgresql/data
    networks: [dataspace]

  # ======================
  # POSTGRES (B)
  # ======================
  postgres-b:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: edc
      POSTGRES_PASSWORD: edc
      POSTGRES_DB: edc
    ports:
      - "5433:5432"
    volumes:
      - postgres_b_data:/var/lib/postgresql/data
    networks: [dataspace]

  # ======================================
  # PARTICIPANT A (EDC OSS - Tractus-X)
  # ======================================
  edc-controlplane-a:
    image: tractusx/edc-controlplane-kafka-local:latest
    depends_on: [vault, kafka, postgres-a]
    environment:
      # Vault
      EDC_VAULT_HASHICORP_URL: "http://vault:8200"
      EDC_VAULT_HASHICORP_TOKEN: "root"

      # Kafka
      EDC_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"

      # Database (required)
      EDC_DATASOURCE_DEFAULT_URL: "jdbc:postgresql://postgres-a:5432/edc"
      EDC_DATASOURCE_DEFAULT_USER: "edc"
      EDC_DATASOURCE_DEFAULT_PASSWORD: "edc"

      # Participant + IAM minimal (POC)
      EDC_PARTICIPANT_ID: "participant-a"
      EDC_IAM_ISSUER_ID: "did:web:participant-a"
      EDC_IAM_TRUSTED_ISSUER_IDS: "did:web:participant-a"
      EDC_IAM_STS_OAUTH_TOKEN_URL: "http://dummy"
      EDC_IAM_STS_OAUTH_CLIENT_ID: "dummy"
      EDC_IAM_STS_OAUTH_CLIENT_SECRET: "dummy"
      EDC_IAM_STS_OAUTH_SCOPE: "dummy"

      # Management API key (POC)
      EDC_API_AUTH_KEY: "password"

      # FIX PORTS (A)
      WEB_HTTP_PORT: "8186"
      WEB_HTTP_PATH: "/api"
      WEB_HTTP_MANAGEMENT_PORT: "8187"
      WEB_HTTP_MANAGEMENT_PATH: "/management"
      WEB_HTTP_PROTOCOL_PORT: "8188"
      WEB_HTTP_PROTOCOL_PATH: "/protocol"

      # DSP callback (IMPORTANT: trailing slash)
      EDC_DSP_CALLBACK_ADDRESS: "http://api-gateway-a:8080/protocol/"
    networks: [dataspace]

  edc-dataplane-a:
    image: tractusx/edc-dataplane-kafka-local:latest
    depends_on: [vault, kafka]
    environment:
      EDC_VAULT_HASHICORP_URL: "http://vault:8200"
      EDC_VAULT_HASHICORP_TOKEN: "root"
      EDC_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"

      # FIX PORTS (A dataplane)
      WEB_HTTP_PORT: "8189"
      WEB_HTTP_PATH: "/"
    networks: [dataspace]

  observability-a:
    build: ./observability
    environment:
      PARTICIPANT_ID: "A"
    networks: [dataspace]

  api-gateway-a:
    image: nginx:alpine
    ports:
      - "8080:8080"
    volumes:
      - ./participant-a/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - edc-controlplane-a
      - edc-dataplane-a
      - observability-a
    networks: [dataspace]

  # ======================================
  # PARTICIPANT B (EDC OSS - Tractus-X)
  # ======================================
  edc-controlplane-b:
    image: tractusx/edc-controlplane-kafka-local:latest
    depends_on: [vault, kafka, postgres-b]
    environment:
      # Vault
      EDC_VAULT_HASHICORP_URL: "http://vault:8200"
      EDC_VAULT_HASHICORP_TOKEN: "root"

      # Kafka
      EDC_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"

      # Database (required)
      EDC_DATASOURCE_DEFAULT_URL: "jdbc:postgresql://postgres-b:5432/edc"
      EDC_DATASOURCE_DEFAULT_USER: "edc"
      EDC_DATASOURCE_DEFAULT_PASSWORD: "edc"

      # Participant + IAM minimal (POC)
      EDC_PARTICIPANT_ID: "participant-b"
      EDC_IAM_ISSUER_ID: "did:web:participant-b"
      EDC_IAM_TRUSTED_ISSUER_IDS: "did:web:participant-b"
      EDC_IAM_STS_OAUTH_TOKEN_URL: "http://dummy"
      EDC_IAM_STS_OAUTH_CLIENT_ID: "dummy"
      EDC_IAM_STS_OAUTH_CLIENT_SECRET: "dummy"
      EDC_IAM_STS_OAUTH_SCOPE: "dummy"

      # Management API key (POC)
      EDC_API_AUTH_KEY: "password"

      # FIX PORTS (B)
      WEB_HTTP_PORT: "8191"
      WEB_HTTP_PATH: "/api"
      WEB_HTTP_MANAGEMENT_PORT: "8193"
      WEB_HTTP_MANAGEMENT_PATH: "/management"
      WEB_HTTP_PROTOCOL_PORT: "8194"
      WEB_HTTP_PROTOCOL_PATH: "/protocol"

      # DSP callback (IMPORTANT: trailing slash)
      EDC_DSP_CALLBACK_ADDRESS: "http://api-gateway-b:8080/protocol/"
    networks: [dataspace]

  edc-dataplane-b:
    image: tractusx/edc-dataplane-kafka-local:latest
    depends_on: [vault, kafka]
    environment:
      EDC_VAULT_HASHICORP_URL: "http://vault:8200"
      EDC_VAULT_HASHICORP_TOKEN: "root"
      EDC_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"

      # FIX PORTS (B dataplane)
      WEB_HTTP_PORT: "8195"
      WEB_HTTP_PATH: "/"
    networks: [dataspace]

  observability-b:
    build: ./observability
    environment:
      PARTICIPANT_ID: "B"
    networks: [dataspace]

  api-gateway-b:
    image: nginx:alpine
    ports:
      - "8081:8080"
    volumes:
      - ./participant-b/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - edc-controlplane-b
      - edc-dataplane-b
      - observability-b
    networks: [dataspace]

  # ======================================
  # CENTRAL (Prometheus + Grafana)
  # ======================================
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./central/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    networks: [dataspace]

  grafana:
    image: grafana/grafana:latest
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./central/grafana-provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks: [dataspace]
